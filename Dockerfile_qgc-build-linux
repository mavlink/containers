#
# QGroundControl linux build environment
#

FROM ubuntu:xenial
MAINTAINER Daniel Agar <daniel@agar.ca>

ENV QMAKESPEC=linux-g++-64

ENV QT_PATH /opt/Qt
ENV QT_DESKTOP $QT_PATH/5.11.0/gcc_64
ENV PATH /usr/lib/ccache:$QT_DESKTOP/bin:$PATH
ENV TERM=xterm

RUN	apt-get update \
	&& DEBIAN_FRONTEND=noninteractive apt-get -y --quiet --no-install-recommends install \
		build-essential \
		ca-certificates \
		ccache \
		cmake \
		espeak \
		g++ \
		gcc \
		git \
		gosu \
		libespeak-dev \
		libfontconfig1 \
		libgstreamer-plugins-base1.0-dev \
		libgstreamer1.0-0:amd64 \
		libgstreamer1.0-dev \
		libsdl2-dev \
		libudev-dev \
		snapcraft \
		speech-dispatcher \
		wget \
	&& apt-get -y autoremove \
	&& apt-get clean autoclean \
	&& rm -rf /var/lib/apt/lists/{apt,dpkg,cache,log} /tmp/* /var/tmp/*

# Download & unpack Qt 5.11.0 toolchains & clean
COPY scripts/extract-qt-installer.sh /tmp/extract-qt-installer.sh
RUN	wget -q "http://download.qt-project.org/official_releases/qt/5.11/5.11.0/qt-opensource-linux-x64-5.11.0.run" -O /tmp/qt-opensource-linux-x64-5.11.0.run \
	&& /tmp/extract-qt-installer.sh --list-packages /tmp/qt-opensource-linux-x64-5.11.0.run \
	&& QT_CI_PACKAGES="qt.qt5.5110.gcc_64,qt.qt5.5110.qtcharts" /tmp/extract-qt-installer.sh /tmp/qt-opensource-linux-x64-5.11.0.run "$QT_PATH" \
	&& rm -rf /tmp/*

# create and start as LOCAL_USER_ID
COPY scripts/entrypoint.sh /usr/local/bin/entrypoint.sh
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

CMD ["/bin/bash"]
